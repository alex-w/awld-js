<?xml version="1.0"?>
<project name="awld.js" default="run-tests">
    
    <!-- define ant-contrib tasks -->
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="lib/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>
    
    <!-- get properties -->
    <property name="config.dir" value="config" />
    <property name="src.dir" value="src" />
    <property name="module.dir" value="${src.dir}/modules" />
    <property name="clientlib.dir" value="${src.dir}/lib" />
    
    <property file="${config.dir}/build.properties" />
    
    <!-- Build targets -->
    
    <target name="build-production">
        <!-- Nothing yet -->
    </target>
    
    <!-- Server targets -->
    
    <target name="start-test-server">
        <exec executable="cmd.exe">
            <arg line="/K start node ${devserver.js} -s ${test.server.port} -r ." />
        </exec>
    </target>
    
    <target name="launch-in-browser">
        <exec executable="cmd.exe">
            <arg line="/K start http://localhost:${test.server.port}/test/pages" />
        </exec>
    </target>
    
    <target name="serve-test"
            depends="start-test-server,
                     launch-in-browser" />
    
    <!-- Test targets -->
    
    <target name="build-tests">
        <!-- Copy files for "custom" setup test -->
        <copy todir="test/pages/custom">
            <fileset dir="${src.dir}" />
        </copy>
        <move file="test/pages/custom/modules" tofile="test/pages/custom/m"/>
        <move file="test/pages/custom/lib" tofile="test/pages/custom/l"/>
    </target>
    
    <target name="clean-tests">
        <delete includeemptydirs="true">
            <fileset dir="test/pages/custom" includes="**/*"/>
        </delete>
    </target>
    
    <target name="run-tests" depends="build-tests, start-test-server">
        <echo>Running tests</echo>
        <property name="suite" value="test/suites"/>
        <exec executable="python" failonerror="true">
            <arg file="${casper.js}" />
            <arg file="test/run.js" />
            <arg file="${suite}" />
        </exec>
        <ant target="clean-tests"/>
    </target>
    
</project>